# Analysis of Remaining Test Failures (Step F2.2.D)

**Branch:** `refactor/cli-yaml-global`
**Context:** Analysis of the 13 test failures reported after running `pytest` in Step F2.2, following the removal of outdated tests in Step F2.1.

## Failure Categories and Root Causes

Based on the provided context and analysis of `cli/main.py`, the 13 failures likely fall into two main categories:

### 1. `AttributeError: ... 'load_cli_config'`

*   **Symptom:** Tests fail with `AttributeError` when attempting to mock or patch `cli.main.load_cli_config`.
*   **Root Cause:** The function `load_cli_config` no longer exists in `cli/main.py` on the `refactor/cli-yaml-global` branch. It was part of the old Markdown-based configuration workflow and was commented out (lines 36-37) during the refactoring towards the new YAML-based configuration (`config.yaml`) handled by `config_loader.load_and_validate_config` and the new `compile` command. The old commands (`add`, `update`, `delete`) that relied on this function are also commented out.
*   **Affected Tests:** Tests that were likely testing the old `add`, `update`, `delete` commands, or directly testing the configuration loading mechanism via `load_cli_config`.
*   **Proposed Solution:**
    *   Identify the specific tests failing with this `AttributeError`.
    *   Evaluate if these tests are still relevant to the new YAML/`compile` workflow.
        *   If **not relevant**, remove the tests.
        *   If **relevant** (e.g., testing aspects of the `compile` command or general CLI behavior), update the tests:
            *   Remove mocks targeting the non-existent `cli.main.load_cli_config`.
            *   Update mocks to target relevant functions in the new workflow if necessary (e.g., `cli.config_loader.load_and_validate_config`, `cli.registry_manager.write_global_registry`).
            *   Adjust test logic to align with the `compile` command's behavior.

### 2. Assertion Errors in Installation/Help Tests

*   **Symptom:** Tests fail due to `AssertionError`, likely when comparing expected CLI output (e.g., help messages) with the actual output.
*   **Root Cause:** The CLI's structure and output have changed significantly. The `add`, `update`, and `delete` commands are commented out in `cli/main.py`, and a new `compile` command has been introduced. Therefore, the output of commands like `agent-config-cli --help` or `agent-config-cli compile --help` has changed. Tests asserting the exact text based on the old command structure are now incorrect.
*   **Affected Tests:** Tests verifying installation (`--help` output) or specific command help messages.
*   **Proposed Solution:**
    *   Identify the specific tests failing with assertion errors related to CLI output.
    *   Update the expected output strings in these tests to match the actual output generated by the refactored CLI on the `refactor/cli-yaml-global` branch. This includes reflecting the presence of the `compile` command and the absence of the `add`, `update`, and `delete` commands in the main help text.

## Conclusion

The remaining 13 test failures are directly attributable to the refactoring work that replaced the old Markdown/JSON configuration workflow with the new YAML/compile workflow. The primary issues are outdated mocks pointing to removed functions and outdated assertions expecting the old CLI command structure and output. The next step (F2.3) should involve implementing the proposed solutions: updating or removing tests with `AttributeError`s and correcting assertions in help/installation tests.