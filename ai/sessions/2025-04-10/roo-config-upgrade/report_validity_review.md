# Review of `report.md` Validity Regarding Custom Instructions

**Date:** 2025-04-10

## 1. Introduction

This document reviews the validity of the conclusions and recommendations presented in the report `ai/sessions/2025-04-10/roo-config-upgrade/report.md` (hereafter "the original report"). The review is conducted in light of the clarified understanding that Roo Code utilizes the `customInstructions` property within the `custom_modes.json` file as one of several potential sources for agent instructions, combining it with file/directory-based instructions and UI settings at runtime.

## 2. Original Report Summary

The original report investigated the impact of Roo Code's file-based custom instruction mechanisms (e.g., `.roo/rules-{modeSlug}/`) on the internal `cli` tool. It found that the `cli` tool currently extracts instructions *only* from specific Markdown headers and writes this content to the `customInstructions` field in the generated `custom_modes.json`.

The report identified this as a discrepancy, as the CLI-generated `customInstructions` value represents only a partial view of the agent's full instructions as interpreted by Roo Code. It evaluated three options:
*   **Option A:** Full replication of Roo Code's instruction assembly logic in the CLI. (Rejected: Too complex, duplicates logic).
*   **Option B:** Decoupling the CLI by removing its logic for extracting and writing the `customInstructions` field. (Recommended: Simplifies CLI, avoids duplication, relies on Roo Code runtime).
*   **Option C:** Partial replication (metadata flags). (Rejected: Adds complexity without fully solving the issue).

The core recommendation was **Option B**: Modify the CLI to stop processing and generating the `customInstructions` field in `custom_modes.json`, relying entirely on Roo Code's runtime assembly.

## 3. Clarified Understanding of `customInstructions`

Subsequent research clarified that the `customInstructions` property within the JSON *is* a valid source that Roo Code considers during its runtime assembly process. It is combined with instructions from files/directories (like `.roo/rules-{modeSlug}/`) and potentially UI settings, following a specific precedence order.

## 4. Validity Assessment of Original Report's Recommendation (Option B)

Based on the clarified understanding, the original report's recommendation (**Option B: Decoupling & Source Removal**) remains **valid and appropriate**.

**Reasoning:**

1.  **Core Problem Persists:** The fundamental issue identified in the original report still holds true. The `cli` tool, by extracting instructions *only* from Markdown, generates an *incomplete and potentially misleading* value for the `customInstructions` field. Even though Roo Code *can* read this field, the value generated by the CLI doesn't accurately represent the full set of instructions Roo Code might assemble from *all* sources (Markdown, JSON, files, UI). Populating this field partially via the CLI creates confusion.
2.  **Avoiding Logic Duplication is Key:** The primary justification for Option B – avoiding the complexity of replicating Roo Code's multi-source instruction assembly logic within the CLI – remains the strongest argument. Attempting Option A (full replication) would make the CLI fragile and difficult to maintain in sync with Roo Code's evolving logic.
3.  **Decoupling is Clean:** Option B cleanly decouples the CLI's responsibility. The CLI's role should be focused on managing the *core* definition of the mode (slug, name, role definition, etc.) derived from the primary Markdown source. The complex task of assembling *instructions* from various potential locations (including the JSON field itself, files, directories) is best left entirely to Roo Code's runtime environment, which is the ultimate source of truth.
4.  **Manual JSON Edits Still Possible:** Removing the CLI's *generation* of the `customInstructions` field does not prevent users from *manually* adding or editing this field directly in `custom_modes.json` if they have a specific need to define baseline instructions directly within the JSON. Roo Code would still pick up these manually added instructions. Option B only removes the CLI's flawed attempt to *automatically populate* this field from a single, incomplete source (Markdown).

## 5. Conclusion

The clarified understanding that the `customInstructions` JSON property is a valid input source for Roo Code does not invalidate the original report's recommendation (Option B). In fact, it reinforces the decision to decouple the CLI from attempting to populate this field. The complexity of Roo Code's multi-source instruction assembly makes it impractical and undesirable to replicate this logic in the CLI.

Therefore, the recommendation to modify the `cli` tool to **stop extracting custom instructions from Markdown and stop writing the `customInstructions` field to `custom_modes.json`** remains the most robust and maintainable approach. Responsibility for instruction assembly should reside solely with Roo Code at runtime.